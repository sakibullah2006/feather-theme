{%- liquid
  assign sort_by = results.sort_by | default: results.default_sort_by
  assign results_url = results.url | default: ''
  if results_url == ''
    assign terms = results.terms | escape
    assign results_url = '?q=' | append: terms | append: '&options%5Bprefix%5D=last&sort_by=' | append: sort_by
  endif
-%}

<div
  class="facets-container"
  x-data="
    {
      sectionId: '{{ section.id }}',
      openMobile: false,
      activeFilter: null,
      priceTimeout: null,

      toggle(id) {
        this.activeFilter = (this.activeFilter === id) ? null : id;
      },
      isOpen(id) {
        return this.activeFilter === id;
      },
      init() {
        window.addEventListener('popstate', (e) => {
          if (e.state && e.state.path) {
            this.filterProducts(e.state.path);
          }
        });

        // Listen for sort changes from the main collection grid
        window.addEventListener('filter-sort-trigger', (e) => {
          if (e.detail && e.detail.url) {
            this.filterProducts(e.detail.url);
          }
        });
      },
      filterProducts(customUrl = null) {
        const form = document.getElementById('FacetFiltersForm');

        if (customUrl) {
          // Custom URL provided (e.g., from sort or popstate)
          $store.hydrator.fetch(
            customUrl,
            this.sectionId,
            ['ProductGridContainer', 'FacetFiltersForm', 'FacetsMobileContent', 'CollectionProductCount']
          );
        } else {
          // Use form data
          $store.hydrator.fetchForm(
            form,
            this.sectionId,
            ['ProductGridContainer', 'FacetFiltersForm', 'FacetsMobileContent', 'CollectionProductCount']
          );
        }
      },
      handlePriceChange() {
        clearTimeout(this.priceTimeout);
        this.priceTimeout = setTimeout(() => this.filterProducts(), 500);
      }
    }
  "
  @toggle-filters.window="openMobile = !openMobile"
>
  {%- comment -%} Filter Form {%- endcomment -%}
  <form id="FacetFiltersForm" class="facets__form" action="{{ results.url }}" method="get">
    {%- if results.terms -%}
      <input type="hidden" name="q" value="{{ results.terms | escape }}">
      <input name="options[prefix]" type="hidden" value="last">
    {%- endif -%}

    <div class="space-y-8 lg:block" :class="{ 'hidden': openMobile }">
      {%- for filter in results.filters -%}
        {%- assign filter_id = filter.label | handleize -%}

        <div class="pt-6 border-t border-gray-100 first:border-t-0 first:pt-0">
          <button
            type="button"
            @click="toggle('{{ filter_id }}')"
            class="flex items-center justify-between w-full group"
          >
            <span class="text-xs font-semibold uppercase tracking-widest text-gray-500 group-hover:text-black transition-colors">
              {{ filter.label | escape }}
              {%- if filter.active_values.size > 0 -%}
                <span class="ml-2 inline-flex items-center justify-center w-4 h-4 text-[9px] bg-black text-white rounded-full">
                  {{ filter.active_values.size }}
                </span>
              {%- endif -%}
            </span>
            <svg
              class="w-3 h-3 transition-transform"
              :class="{ 'rotate-180': isOpen('{{ filter_id }}') }"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 15l-7-7-7 7"></path>
            </svg>
          </button>

          <div x-show="isOpen('{{ filter_id }}')" x-collapse x-cloak class="pt-4">
            {% case filter.type %}
              {% when 'boolean', 'list' %}
                <ul class="space-y-3">
                  {%- for value in filter.values -%}
                    <li class="flex items-center">
                      <input
                        type="checkbox"
                        name="{{ value.param_name }}"
                        value="{{ value.value }}"
                        id="Filter-{{ filter.label | handleize }}-{{ forloop.index }}"
                        @change="filterProducts()"
                        {% if value.active %}
                          checked
                        {% endif %}
                        {% if value.count == 0 and value.active == false %}
                          disabled
                        {% endif %}
                        class="h-5 w-5 rounded border-gray-200 text-black focus:ring-black"
                      >
                      <label
                        for="Filter-{{ filter.label | handleize }}-{{ forloop.index }}"
                        class="ml-3 text-sm text-gray-600"
                      >
                        {{ value.label | escape }} ({{ value.count }})
                      </label>
                    </li>
                  {%- endfor -%}
                </ul>

              {% when 'price_range' %}
                <div
                  x-data="
                    {
                      min: {{ filter.min_value.value | default: 0 | divided_by: 100.0 }},
                      max: {{ filter.max_value.value | default: filter.range_max | divided_by: 100.0 }},
                      rangeMax: {{ filter.range_max | divided_by: 100.0 }}
                    }
                  "
                  class="space-y-4"
                >
                  <div class="flex items-center gap-4">
                    <div class="flex-1">
                      <span class="text-[10px] text-gray-400 uppercase">Min</span>
                      <input
                        name="{{ filter.min_value.param_name }}"
                        x-model="min"
                        @input="handlePriceChange()"
                        type="number"
                        class="w-full text-sm border-gray-200 rounded"
                      >
                    </div>
                    <div class="flex-1">
                      <span class="text-[10px] text-gray-400 uppercase">Max</span>
                      <input
                        name="{{ filter.max_value.param_name }}"
                        x-model="max"
                        @input="handlePriceChange()"
                        type="number"
                        class="w-full text-sm border-gray-200 rounded"
                      >
                    </div>
                  </div>
                </div>
            {% endcase %}
          </div>
        </div>
      {%- endfor -%}
    </div>
  </form>

  {%- comment -%} Mobile Drawer Content {%- endcomment -%}
  <template x-teleport="body">
    <div x-show="openMobile" class="fixed inset-0 z-[100] lg:hidden" x-cloak>
      <div @click="openMobile = false" class="fixed inset-0 bg-black/50 backdrop-blur-sm"></div>
      <div class="fixed inset-y-0 right-0 w-full max-w-xs bg-white shadow-xl flex flex-col">
        <div class="p-6 border-b flex justify-between items-center">
          <h2 class="font-bold">Filters</h2>
          <button @click="openMobile = false">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>

        <div id="FacetsMobileContent" class="flex-1 overflow-y-auto p-6">
          {%- comment -%} The content here is mirrored via the renderPart function {%- endcomment -%}
          <div class="mobile-sorting mb-6">
            <label class="text-[10px] font-bold uppercase tracking-widest text-gray-400 block mb-2">Sort By</label>
            <select
              name="sort_by"
              form="FacetFiltersForm"
              @change="filterProducts()"
              class="w-full border-gray-200 rounded-lg"
            >
              {%- for option in results.sort_options -%}
                <option
                  value="{{ option.value }}"
                  {% if option.value == sort_by %}
                    selected
                  {% endif %}
                >
                  {{ option.name }}
                </option>
              {%- endfor -%}
            </select>
          </div>
        </div>

        <div class="p-6 border-t bg-gray-50 flex gap-3">
          <a href="{{ results_url }}" class="flex-1 text-center py-3 border border-black rounded-lg text-sm font-bold"
            >Clear</a
          >
          <button @click="openMobile = false" class="flex-1 py-3 bg-black text-white rounded-lg text-sm font-bold">
            Apply
          </button>
        </div>
      </div>
    </div>
  </template>
</div>
