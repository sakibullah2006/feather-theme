{%- liquid
  assign sort_by = results.sort_by | default: results.default_sort_by
  assign results_url = results.url | default: ''
  if results_url == ''
    assign terms = results.terms | escape
    assign results_url = '?q=' | append: terms | append: '&options%5Bprefix%5D=last&sort_by=' | append: sort_by
  endif
-%}

<div
  class="facets-container"
  x-data="
    {
      sectionId: '{{ section.id }}',
      openMobile: false,

      filterProducts(customUrl = null) {
        const form = document.getElementById('FacetFiltersForm');

        if (customUrl) {
          $store.hydrator.fetch(
            customUrl,
            this.sectionId,
            ['ProductGridContainer', 'FacetFiltersForm', 'FacetsMobileContent', 'CollectionProductCount']
          );
        } else {
          $store.hydrator.fetchForm(
            form,
            this.sectionId,
            ['ProductGridContainer', 'FacetFiltersForm', 'FacetsMobileContent', 'CollectionProductCount']
          );
        }
      }
    }
  "
  @toggle-filters.window="openMobile = !openMobile"
  @popstate.window="if ($event.state && $event.state.path) filterProducts($event.state.path)"
>
  {%- comment -%} Filter Form {%- endcomment -%}
  <form id="FacetFiltersForm" class="facets__form" action="{{ results.url }}" method="get">
    {%- if results.terms -%}
      <input type="hidden" name="q" value="{{ results.terms | escape }}">
      <input name="options[prefix]" type="hidden" value="last">
    {%- endif -%}
    <input type="hidden" name="sort_by" value="{{ results.sort_by | default: results.default_sort_by }}">

    <div class="space-y-8 lg:block" :class="{ 'hidden': openMobile }">
      {%- for filter in results.filters -%}
        {%- assign filter_id = filter.label | handleize -%}
        {%- assign is_product_type = false -%}
        {%- if filter.param_name == 'filter.p.product_type' -%}
          {%- assign is_product_type = true -%}
        {%- endif -%}

        {%- if is_product_type -%}
          {%- comment -%} Product Type as always-open div {%- endcomment -%}
          <div class="pt-6 border-t border-gray-100 first:border-t-0 first:pt-0">
            <div class="pb-4">
              <span class="text-xs  flex items-center justify-start font-semibold uppercase tracking-widest text-gray-500">
                <span>
                  {{ filter.label | escape }}
                </span>
                {%- if filter.active_values.size > 0 -%}
                  <span class="ml-2 inline-flex items-center justify-center w-4 h-4 text-[9px] bg-black text-white rounded-full">
                    {{ filter.active_values.size }}
                  </span>
                {%- endif -%}
              </span>
            </div>

            <div class="">
              {% case filter.type %}
                {% when 'boolean', 'list' %}
                  <ul class="">
                    {%- for value in filter.values -%}
                      <li class="py-2">
                        <input
                          type="radio"
                          hidden
                          name="{{ filter.param_name }}"
                          value="{{ value.value }}"
                          id="Filter-{{ filter.label | handleize }}-{{ forloop.index }}"
                          @change="filterProducts()"
                          {% comment %} toggle effect for radio  eg. true <-> false {% endcomment %}
                          @click="if ($el.checked && {{ value.active | json }}) { $el.checked = false; filterProducts(); }"

                          {% if value.active %}
                            checked
                          {% endif %}
                          {% if value.count == 0 and value.active == false %}
                            disabled
                          {% endif %}
                          class="h-5 w-5  rounded border-gray-200 text-black focus:ring-black focus:ring-offset-0 transition-all duration-250 ease-in-out cursor-pointer disabled:cursor-not-allowed disabled:opacity-40"
                        >
                        <label
                          for="Filter-{{ filter.label | handleize }}-{{ forloop.index }}"
                          class="ml-1 text-sm text-gray-600 cursor-pointer transition-colors w-full flex justify-between  duration-250 hover:text-black select-none"
                        >
                          <span class="ease-in-out transition-opacity duration-250 {% if value.active %}opacity-100 font-semibold{% else %}opacity-60 group-hover:opacity-100{% endif %}">
                            {{ value.label | escape }}
                          </span>
                          <span> ({{ value.count }}) </span>
                        </label>
                      </li>
                    {%- endfor -%}
                  </ul>
              {% endcase %}
            </div>
          </div>
        {%- else -%}
          {%- comment -%} Other filters as accordion {%- endcomment -%}
          <details class="pt-6 border-t border-gray-100 first:border-t-0 first:pt-0 group/details">
            <summary class="flex items-center justify-between w-full cursor-pointer py-1 -my-1 list-none [&::-webkit-details-marker]:hidden group/summary">
              <span class="text-xs font-semibold uppercase tracking-widest text-gray-500 group-hover/summary:text-black transition-colors duration-250">
                {{ filter.label | escape }}
                {%- if filter.active_values.size > 0 -%}
                  <span class="ml-2 inline-flex items-center justify-center w-4 h-4 text-[9px] bg-black text-white rounded-full transition-all duration-250">
                    {{ filter.active_values.size }}
                  </span>
                {%- endif -%}
              </span>
              <svg
                class="w-3 h-3 transition-transform duration-250 ease-in-out text-gray-400 group-hover/summary:text-black group-open/details:rotate-180"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 15l-7-7-7 7"></path>
              </svg>
            </summary>

            <div class="max-h-0 overflow-hidden group-open/details:max-h-250 transition-[max-height] duration-250 ease-in-out">
              <div class="pt-4">
                {% case filter.type %}
                  {% when 'boolean', 'list' %}
                    {%- if filter_id == 'color' or filter_id == 'colour' -%}
                      <div class="flex flex-wrap gap-3">
                        {%- for value in filter.values -%}
                          <div class="relative">
                            <input
                              type="checkbox"
                              name="{{ value.param_name }}"
                              value="{{ value.value }}"
                              id="Filter-{{ filter.label | handleize }}-{{ forloop.index }}"
                              @change="filterProducts()"
                              {% if value.active %}
                                checked
                              {% endif %}
                              {% if value.count == 0 and value.active == false %}
                                disabled
                              {% endif %}
                              class="peer sr-only"
                            >
                            <label
                              for="Filter-{{ filter.label | handleize }}-{{ forloop.index }}"
                              class="flex border rounded-full px-1 py-1 items-center gap-1  {% if value.count == 0 and value.active == false %}opacity-40 cursor-not-allowed{% else %}cursor-pointer{% endif %} group  {% if value.active %}border-green-400 font-semibold{% else %}border-gray-200{% endif %}  transition-colors duration-250"
                            >
                              <span
                                class="w-3 h-3 rounded-full transition-all duration-200 border border-x"
                                style="
                                  background-color: {{ value.label | handle }};
                                  {%- if value.swatch.color -%}
                                    background-color: {{ value.swatch.color }};
                                  {%- endif -%}
                                  {%- if value.swatch.image -%}
                                    background-image: url({{ value.swatch.image | image_url: width: 64, height: 64 }});
                                    background-size: cover;
                                    background-position: center;
                                  {%- endif -%}
                                "
                              ></span>
                              <span class="text-xs">{{ value.label | escape }}</span>
                            </label>
                          </div>
                        {%- endfor -%}
                      </div>
                    {%- else -%}
                      <ul class="space-y-3">
                        {%- for value in filter.values -%}
                          <li class="flex items-center">
                            <input
                              type="checkbox"
                              name="{{ value.param_name }}"
                              value="{{ value.value }}"
                              id="Filter-{{ filter.label | handleize }}-{{ forloop.index }}"
                              @change="filterProducts()"
                              {% if value.active %}
                                checked
                              {% endif %}
                              {% if value.count == 0 and value.active == false %}
                                disabled
                              {% endif %}
                              class="h-5 w-5 rounded border-gray-200 text-black focus:ring-black focus:ring-offset-0 transition-all duration-250 ease-in-out cursor-pointer disabled:cursor-not-allowed disabled:opacity-40"
                            >
                            <label
                              for="Filter-{{ filter.label | handleize }}-{{ forloop.index }}"
                              class="ml-1 w-full flex items-center justify-between gap-1 text-sm text-gray-600 cursor-pointer transition-colors duration-250 hover:text-black select-none"
                            >
                              <span>
                                {{ value.label | escape }}
                              </span>
                              <span
                                {% if value.active %}
                                  class="font-semibold"
                                {% endif %}
                              >
                                ({{ value.count }})
                              </span>
                            </label>
                          </li>
                        {%- endfor -%}
                      </ul>
                    {%- endif -%}

                  {% when 'price_range' %}
                    <div
                      x-data="
                        {
                          min: {{ filter.min_value.value | default: 0 | divided_by: 100.0 }},
                          max: {{ filter.max_value.value | default: filter.range_max | divided_by: 100.0 }},
                          rangeMax: {{ filter.range_max | divided_by: 100.0 }}
                        }
                      "
                      class="space-y-4"
                    >
                      <div class="flex items-center gap-4">
                        <div class="flex-1">
                          <span class="text-[10px] text-gray-400 uppercase">Min</span>
                          <input
                            name="{{ filter.min_value.param_name }}"
                            x-model="min"
                            @input="handlePriceChange()"
                            type="number"
                            class="w-full text-sm border-gray-200 rounded"
                          >
                        </div>
                        <div class="flex-1">
                          <span class="text-[10px] text-gray-400 uppercase">Max</span>
                          <input
                            name="{{ filter.max_value.param_name }}"
                            x-model="max"
                            @input="handlePriceChange()"
                            type="number"
                            class="w-full text-sm border-gray-200 rounded"
                          >
                        </div>
                      </div>
                    </div>
                {% endcase %}
              </div>
            </div>
          </details>
        {%- endif -%}
      {%- endfor -%}
    </div>
  </form>

  {%- comment -%} Mobile Drawer Content {%- endcomment -%}
  {% render 'facets-drawer', results: results, sort_by: sort_by, results_url: results_url %}
</div>
