{%- liquid
  assign sort_by = results.sort_by | default: results.default_sort_by
  assign results_url = results.url | default: ''
  if results_url == ''
    assign terms = results.terms | escape
    assign results_url = '?q=' | append: terms | append: '&options%5Bprefix%5D=last&sort_by=' | append: sort_by
  endif
-%}

<div
  class="facets-container"
  x-data="
    {
      sectionId: '{{ section.id }}',
      openMobile: false,
      priceTimeout: null,

      init() {
        window.addEventListener('popstate', (e) => {
          if (e.state && e.state.path) {
            this.filterProducts(e.state.path);
          }
        });

        // Listen for sort changes from the main collection grid
        window.addEventListener('filter-sort-trigger', (e) => {
          if (e.detail && e.detail.url) {
            this.filterProducts(e.detail.url);
          }
        });
      },
      filterProducts(customUrl = null) {
        const form = document.getElementById('FacetFiltersForm');

        if (customUrl) {
          // Custom URL provided (e.g., from sort or popstate)
          $store.hydrator.fetch(
            customUrl,
            this.sectionId,
            ['ProductGridContainer', 'FacetFiltersForm', 'FacetsMobileContent', 'CollectionProductCount']
          );
        } else {
          // Use form data
          $store.hydrator.fetchForm(
            form,
            this.sectionId,
            ['ProductGridContainer', 'FacetFiltersForm', 'FacetsMobileContent', 'CollectionProductCount']
          );
        }
      },
      handlePriceChange() {
        clearTimeout(this.priceTimeout);
        this.priceTimeout = setTimeout(() => this.filterProducts(), 500);
      }

    }
  "
  @toggle-filters.window="openMobile = !openMobile"
>
  {%- comment -%} Filter Form {%- endcomment -%}
  <form id="FacetFiltersForm" class="facets__form" action="{{ results.url }}" method="get">
    {%- if results.terms -%}
      <input type="hidden" name="q" value="{{ results.terms | escape }}">
      <input name="options[prefix]" type="hidden" value="last">
    {%- endif -%}

    <div class="space-y-8 lg:block" :class="{ 'hidden': openMobile }">
      {%- for filter in results.filters -%}
        {%- assign filter_id = filter.label | handleize -%}
        {%- assign is_product_type = false -%}
        {%- if filter.param_name == 'filter.p.product_type' -%}
          {%- assign is_product_type = true -%}
        {%- endif -%}

        {%- if is_product_type -%}
          {%- comment -%} Product Type as always-open div {%- endcomment -%}
          <div class="pt-6 border-t border-gray-100 first:border-t-0 first:pt-0">
            <div class="pb-4">
              <span class="text-xs  flex items-center justify-start font-semibold uppercase tracking-widest text-gray-500">
                <span>
                  {{ filter.label | escape }}
                </span>
                {%- if filter.active_values.size > 0 -%}
                  <span class="ml-2 inline-flex items-center justify-center w-4 h-4 text-[9px] bg-black text-white rounded-full">
                    {{ filter.active_values.size }}
                  </span>
                {%- endif -%}
              </span>
            </div>

            <div class="">
              {% case filter.type %}
                {% when 'boolean', 'list' %}
                  <ul class="">
                    {%- for value in filter.values -%}
                      <li class="py-2">
                        <input
                          type="radio"
                          hidden
                          name="{{ filter.param_name }}"
                          value="{{ value.value }}"
                          id="Filter-{{ filter.label | handleize }}-{{ forloop.index }}"
                          @change="filterProducts()"
                          {% comment %} toggle effect for radio  eg. true <-> false {% endcomment %}
                          @click="if ($el.checked && {{ value.active | json }}) { $el.checked = false; filterProducts(); }"

                          {% if value.active %}
                            checked
                          {% endif %}
                          {% if value.count == 0 and value.active == false %}
                            disabled
                          {% endif %}
                          class="h-5 w-5  rounded border-gray-200 text-black focus:ring-black focus:ring-offset-0 transition-all duration-250 ease-in-out cursor-pointer disabled:cursor-not-allowed disabled:opacity-40"
                        >
                        <label
                          for="Filter-{{ filter.label | handleize }}-{{ forloop.index }}"
                          class="ml-1 text-sm text-gray-600 cursor-pointer transition-colors w-full flex justify-between  duration-250 hover:text-black select-none"
                        >
                          <span class="ease-in-out transition-opacity duration-250 {% if value.active %}opacity-100 font-semibold{% else %}opacity-60 group-hover:opacity-100{% endif %}">
                            {{ value.label | escape }}
                          </span>
                          <span> ({{ value.count }}) </span>
                        </label>
                      </li>
                    {%- endfor -%}
                  </ul>
              {% endcase %}
            </div>
          </div>
        {%- else -%}
          {%- comment -%} Other filters as accordion {%- endcomment -%}
          <details class="pt-6 border-t border-gray-100 first:border-t-0 first:pt-0 group/details">
            <summary class="flex items-center justify-between w-full cursor-pointer py-1 -my-1 list-none [&::-webkit-details-marker]:hidden group/summary">
              <span class="text-xs font-semibold uppercase tracking-widest text-gray-500 group-hover/summary:text-black transition-colors duration-250">
                {{ filter.label | escape }}
                {%- if filter.active_values.size > 0 -%}
                  <span class="ml-2 inline-flex items-center justify-center w-4 h-4 text-[9px] bg-black text-white rounded-full transition-all duration-250">
                    {{ filter.active_values.size }}
                  </span>
                {%- endif -%}
              </span>
              <svg
                class="w-3 h-3 transition-transform duration-250 ease-in-out text-gray-400 group-hover/summary:text-black group-open/details:rotate-180"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 15l-7-7-7 7"></path>
              </svg>
            </summary>

            <div class="max-h-0 overflow-hidden group-open/details:max-h-250 transition-[max-height] duration-250 ease-in-out">
              <div class="pt-4">
                {% case filter.type %}
                  {% when 'boolean', 'list' %}
                    <ul class="space-y-3">
                      {%- for value in filter.values -%}
                        <li class="flex items-center">
                          <input
                            type="checkbox"
                            name="{{ value.param_name }}"
                            value="{{ value.value }}"
                            id="Filter-{{ filter.label | handleize }}-{{ forloop.index }}"
                            @change="filterProducts()"
                            {% if value.active %}
                              checked
                            {% endif %}
                            {% if value.count == 0 and value.active == false %}
                              disabled
                            {% endif %}
                            class="h-5 w-5 rounded border-gray-200 text-black focus:ring-black focus:ring-offset-0 transition-all duration-250 ease-in-out cursor-pointer disabled:cursor-not-allowed disabled:opacity-40"
                          >
                          <label
                            for="Filter-{{ filter.label | handleize }}-{{ forloop.index }}"
                            class="ml-3 text-sm text-gray-600 cursor-pointer transition-colors duration-250 hover:text-black select-none"
                          >
                            {{ value.label | escape }} ({{ value.count }})
                          </label>
                        </li>
                      {%- endfor -%}
                    </ul>

                  {% when 'price_range' %}
                    <div
                      x-data="
                        {
                          min: {{ filter.min_value.value | default: 0 | divided_by: 100.0 }},
                          max: {{ filter.max_value.value | default: filter.range_max | divided_by: 100.0 }},
                          rangeMax: {{ filter.range_max | divided_by: 100.0 }}
                        }
                      "
                      class="space-y-4"
                    >
                      <div class="flex items-center gap-4">
                        <div class="flex-1">
                          <span class="text-[10px] text-gray-400 uppercase">Min</span>
                          <input
                            name="{{ filter.min_value.param_name }}"
                            x-model="min"
                            @input="handlePriceChange()"
                            type="number"
                            class="w-full text-sm border-gray-200 rounded"
                          >
                        </div>
                        <div class="flex-1">
                          <span class="text-[10px] text-gray-400 uppercase">Max</span>
                          <input
                            name="{{ filter.max_value.param_name }}"
                            x-model="max"
                            @input="handlePriceChange()"
                            type="number"
                            class="w-full text-sm border-gray-200 rounded"
                          >
                        </div>
                      </div>
                    </div>
                {% endcase %}
              </div>
            </div>
          </details>
        {%- endif -%}
      {%- endfor -%}
    </div>
  </form>

  {%- comment -%} Mobile Drawer Content {%- endcomment -%}
  <template x-teleport="body">
    <div
      x-show="openMobile"
      x-transition:enter="ease-out duration-[250ms]"
      x-transition:enter-start="opacity-0"
      x-transition:enter-end="opacity-100"
      x-transition:leave="ease-in duration-[200ms]"
      x-transition:leave-start="opacity-100"
      x-transition:leave-end="opacity-0"
      class="fixed inset-0 z-100 lg:hidden"
      x-cloak
    >
      <div @click="openMobile = false" class="fixed inset-0 bg-black/50 backdrop-blur-sm"></div>
      <div
        x-show="openMobile"
        x-transition:enter="ease-out duration-[250ms]"
        x-transition:enter-start="translate-x-full"
        x-transition:enter-end="translate-x-0"
        x-transition:leave="ease-in duration-[200ms]"
        x-transition:leave-start="translate-x-0"
        x-transition:leave-end="translate-x-full"
        class="fixed inset-y-0 right-0 w-full max-w-xs bg-white shadow-xl flex flex-col transform"
      >
        <div class="p-6 border-b flex justify-between items-center">
          <h2 class="font-bold">Filters</h2>
          <button
            @click="openMobile = false"
            class="p-2 -m-2 hover:bg-gray-100 rounded-lg transition-colors duration-250"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>

        <div id="FacetsMobileContent" class="flex-1 overflow-y-auto p-6">
          {%- comment -%} The content here is mirrored via the renderPart function {%- endcomment -%}
          <div class="mobile-sorting mb-6">
            <label class="text-[10px] font-bold uppercase tracking-widest text-gray-400 block mb-2">Sort By</label>
            <select
              name="sort_by"
              form="FacetFiltersForm"
              @change="filterProducts()"
              class="w-full border-gray-200 rounded-lg"
            >
              {%- for option in results.sort_options -%}
                <option
                  value="{{ option.value }}"
                  {% if option.value == sort_by %}
                    selected
                  {% endif %}
                >
                  {{ option.name }}
                </option>
              {%- endfor -%}
            </select>
          </div>
        </div>

        <div class="p-6 border-t bg-gray-50 flex gap-3">
          <a
            href="{{ results_url }}"
            class="flex-1 text-center py-3 border border-black rounded-lg text-sm font-bold hover:bg-black hover:text-white transition-colors duration-250"
            >Clear</a
          >
          <button
            @click="openMobile = false"
            class="flex-1 py-3 bg-black text-white rounded-lg text-sm font-bold hover:bg-gray-800 transition-colors duration-250 active:scale-95"
          >
            Apply
          </button>
        </div>
      </div>
    </div>
  </template>
</div>
