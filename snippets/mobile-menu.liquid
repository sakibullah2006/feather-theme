{% comment %}
  Mobile menu drawer component
  Accepts:
  - menu: {Object} Menu object with links
  - show_account: {Boolean} Whether to show account link
{% endcomment %}

{% stylesheet %}
  @keyframes slideInRight {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  @keyframes slideOutRight {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(100%);
      opacity: 0;
    }
  }

  .slide-in-right {
    animation: slideInRight ease-out forwards;
  }

  .slide-out-right {
    animation: slideOutRight ease-in forwards;
  }
{% endstylesheet %}

<div
  x-cloak
  x-show="mobileOpen"
  class="fixed inset-0 z-50 lg:hidden transition-opacity duration-300 "
  aria-modal="true"
  role="dialog"
  aria-label="Mobile navigation menu"
>
  <div
    x-show="mobileOpen"
    x-transition:enter="transition-opacity duration-300"
    x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100"
    x-transition:leave="transition-opacity duration-300"
    x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    class="absolute inset-0 bg-black/40"
    @click="$dispatch('close-mobile')"
    aria-hidden="true"
  ></div>
  <div class="absolute inset-y-0 right-0 w-[min(100vw,320px)] [@media(min-width:400px)]:w-full [@media(min-width:400px)]:max-w-sm sm:max-w-md">
    <div
      x-show="mobileOpen"
      class="relative h-full bg-[rgb(var(--color-background))] text-[rgb(var(--color-foreground))] shadow-2xl flex flex-col transition"
      x-transition:enter="transition-all duration-500 ease-[cubic-bezier(0.25,0.46,0.45,0.94)]"
      x-transition:enter-start="transform translate-x-full"
      x-transition:enter-end="transform translate-x-0"
      x-transition:leave="transition-all duration-500 ease-[cubic-bezier(0.25,0.46,0.45,0.94)]"
      x-transition:leave-start="transform translate-x-0"
      x-transition:leave-end="transform translate-x-full"
      x-trap="mobileOpen"
    >
      {% comment %} Top Bar {% endcomment %}
      <div class="flex items-center justify-between px-3 [@media(min-width:400px)]:px-4 py-2 [@media(min-width:400px)]:py-3 sm:py-4 border-b border-current/10 flex-shrink-0">
        <span class="text-sm [@media(min-width:400px)]:text-base font-semibold">Menu</span>

        {% comment %} close button {% endcomment %}
        <button
          type="button"
          class="w-10 h-10 [@media(min-width:400px)]:w-11 [@media(min-width:400px)]:h-11 inline-flex items-center justify-center rounded-md hover:bg-current/5 active:bg-current/10 transition-colors -mr-1.5 [@media(min-width:400px)]:-mr-2"
          @click="$dispatch('close-mobile')"
          aria-label="Close menu"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 6l12 12M6 18L18 6" />
          </svg>
        </button>
      </div>

      {% comment %} Menu {% endcomment %}
      <div
        class="flex-1 overflow-y-auto px-3 [@media(min-width:400px)]:px-4 py-2 [@media(min-width:400px)]:py-3 overscroll-contain"
        style="-webkit-overflow-scrolling: touch;"
      >
        <nav class="space-y-0 pb-safe" x-data="collapsible()" role="navigation" aria-label="Primary navigation">
          {%- for link in menu.links -%}
            {% if link.links.size > 0 %}
              {% assign has_children = true %}
            {% else %}
              {% assign has_children = false %}
            {% endif %}
            <div class="border-b border-current/10">
              {%- if has_children -%}
                <button
                  type="button"
                  class="w-full flex items-center justify-between px-0 py-2 [@media(min-width:400px)]:py-3 sm:py-3.5 text-left text-sm font-normal hover:opacity-70 active:opacity-50 transition min-h-10 [@media(min-width:400px)]:min-h-11"
                  @click="toggle('{{ forloop.index }}')"
                  aria-expanded="false"
                  :aria-expanded="isOpen('{{ forloop.index }}').toString()"
                >
                  <a href="{{ link.url }}" class="flex-1" @click.stop>{{ link.title }}</a>
                  <svg
                    class="size-4 [@media(min-width:400px)]:size-5 transition-transform duration-200"
                    :class="isOpen('{{ forloop.index }}') ? 'rotate-45' : ''"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    viewBox="0 0 24 24"
                  >
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 5v14m7-7H5" />
                  </svg>
                </button>
                <div x-show="isOpen('{{ forloop.index }}')" x-collapse>
                  <div
                    class="flex flex-col pb-2 [@media(min-width:400px)]:pb-3 pl-3 [@media(min-width:400px)]:pl-4"
                    x-data="collapsible()"
                  >
                    {%- for child in link.links -%}
                      {% if child.links.size > 0 %}
                        {% assign has_grandchildren = true %}
                      {% else %}
                        {% assign has_grandchildren = false %}
                      {% endif %}

                      {%- if has_grandchildren -%}
                        <div class="border-b border-current/5">
                          <button
                            type="button"
                            class="w-full flex items-center justify-between py-2 [@media(min-width:400px)]:py-3 sm:py-4 text-left text-sm text-current/70 hover:text-current active:text-current transition min-h-9 [@media(min-width:400px)]:min-h-10"
                            @click="toggle('{{ forloop.parentloop.index }}-{{ forloop.index }}')"
                            aria-expanded="false"
                            :aria-expanded="isOpen('{{ forloop.parentloop.index }}-{{ forloop.index }}').toString()"
                          >
                            <a href="{{ child.url }}" class="flex-1" @click.stop>{{ child.title }}</a>

                            <svg
                              class="w-4 h-4 transition-transform duration-200"
                              :class="isOpen('{{ forloop.parentloop.index }}-{{ forloop.index }}') ? 'rotate-45' : ''"
                              fill="none"
                              stroke="currentColor"
                              stroke-width="2"
                              viewBox="0 0 24 24"
                            >
                              <path stroke-linecap="round" stroke-linejoin="round" d="M12 5v14m7-7H5" />
                            </svg>
                          </button>
                          <div x-show="isOpen('{{ forloop.parentloop.index }}-{{ forloop.index }}')" x-collapse>
                            <div class="flex flex-col pb-2 pl-3 [@media(min-width:400px)]:pl-4">
                              {%- for grandchild in child.links -%}
                                <a
                                  href="{{ grandchild.url }}"
                                  class="py-2 text-sm text-current/60 hover:text-current transition"
                                >
                                  {{ grandchild.title }}
                                </a>
                              {%- endfor -%}
                            </div>
                          </div>
                        </div>
                      {%- else -%}
                        <a
                          href="{{ child.url }}"
                          class="block py-2 [@media(min-width:400px)]:py-2.5 sm:py-3 text-sm text-current/70 hover:text-current active:text-current transition min-h-[36px] [@media(min-width:400px)]:min-h-[40px] flex items-center"
                        >
                          {{- child.title -}}
                        </a>
                      {%- endif -%}
                    {%- endfor -%}
                  </div>
                </div>
              {%- else -%}
                <a
                  href="{{ link.url }}"
                  class="block px-0 py-3 text-sm font-normal hover:opacity-70 transition"
                >
                  {{ link.title }}
                </a>
              {%- endif -%}
            </div>
          {%- endfor -%}
        </nav>
      </div>

      {% comment %} Footer {% endcomment %}
      <div class="px-3 [@media(min-width:400px)]:px-4 py-2 [@media(min-width:400px)]:py-3 sm:py-4 pb-safe border-t border-current/10 flex items-center justify-between gap-2 [@media(min-width:400px)]:gap-4 flex-shrink-0">
        {%- if show_account -%}
          {%- if customer -%}
            <div class="flex items-center gap-3 flex-1">
              <a
                href="{{ routes.account_url }}"
                class="flex items-center gap-2 text-sm font-medium hover:opacity-80 transition-opacity"
                rel="nofollow"
              >
                <div class="w-8 h-8 rounded-full bg-current/10 flex items-center justify-center">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 12a5 5 0 100-10 5 5 0 000 10zM4 20.5c0-3.59 3.13-6.5 7-6.5s7 2.91 7 6.5" />
                  </svg>
                </div>
                <div class="flex flex-col">
                  <span class="text-xs text-current/60">{{ 'customer.account.title' | t }}</span>
                  <span class="font-medium">{{ customer.first_name | default: customer.email | truncate: 20 }}</span>
                </div>
              </a>
              <a
                href="{{ routes.account_logout_url }}"
                class="ml-auto text-xs text-current/60 hover:text-current underline transition-colors"
                rel="nofollow"
              >
                {{ 'customer.log_out' | t }}
              </a>
            </div>
          {%- else -%}
            <a
              href="{{ routes.account_login_url }}"
              class="flex items-center gap-2 text-sm font-medium hover:opacity-80 transition-opacity"
              rel="nofollow"
            >
              <div class="w-8 h-8 rounded-full bg-current/10 flex items-center justify-center">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15 12H3m0 0l3.5-3.5M3 12l3.5 3.5M15 3h4a2 2 0 012 2v14a2 2 0 01-2 2h-4" />
                </svg>
              </div>
              <span>{{ 'customer.log_in' | t }}</span>
            </a>
          {%- endif -%}
        {%- endif -%}
        <a
          href="{{ routes.cart_url }}"
          class="flex items-center gap-1 text-sm font-medium hover:opacity-80 transition-opacity"
        >
          <div class="w-8 h-8 rounded-full bg-current/10 flex items-center justify-center relative">
            {% render 'cart-logo', class: 'size-5' %}
            {%- if cart != empty -%}
              <span class="absolute -top-1 -right-1 rounded-full bg-current text-[rgb(var(--color-background))] text-[10px] font-bold min-w-[18px] h-[18px] flex items-center justify-center px-1">
                {{- cart.item_count -}}
              </span>
            {%- endif -%}
          </div>
          <span class="[@media(min-width:400px)]:inline">{{ 'templates.cart.cart' | t }}</span>
        </a>
      </div>
    </div>
  </div>
</div>
