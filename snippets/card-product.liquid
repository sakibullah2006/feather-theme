{% doc %}
  Renders a product card.

  @param {product} product - The product object
  @param {collection} collection - The collection object for URL context
  @param {string} image_ratio - Image aspect ratio: "square", "portrait", or "adapt"
  @param {string} card_image_position - CSS class for image positioning
  @param {boolean} quick_view - Whether to show quick view button

  @example
  {% render 'card-product',
    product: product,
    collection: collection,
    image_ratio: 'square',
    card_image_position: 'object-center',
    quick_view: true
  %}
{% enddoc %}

{%- assign first_variant = product.selected_or_first_available_variant -%}
{%- assign initial_img = first_variant.featured_image | default: product.featured_image -%}
{%- liquid
  if first_variant.compare_at_price and first_variant.compare_at_price > 0
    assign first_discount = first_variant.compare_at_price | minus: first_variant.price | times: 100 | divided_by: first_variant.compare_at_price | round
  else
    assign first_discount = 0
  endif

  if initial_img
    assign initial_img_url = initial_img | image_url: width: 1100
  else
    assign initial_img_url = ''
  endif

  if first_variant.url
    assign first_variant_url = first_variant.url | within: collection
  else
    assign first_variant_url = product.url
  endif
-%}
<div
  class="group/card overflow-hidden"
  x-data="
    {
      currentImage: '{{ initial_img_url }}',
      currentPrice: '{{ first_variant.price | money }}',
      currentCompareAtPrice: '{{ first_variant.compare_at_price | money }}',
      discount: '{{ first_discount }}%',
      currentUrl: '{{ first_variant_url }}',
      activeVariantId: {{ first_variant.id | default: 0 }}
    }
  "
>
  {% comment %} Image {% endcomment %}
  <div class="rounded-t-md overflow-hidden relative group/image">
    <a :href="currentUrl">
      {% if image_ratio == 'square' %}
        {% assign image_class = 'object-cover aspect-square' %}
      {% elsif image_ratio == 'adapt' %}
        {% assign image_class = 'object-contain w-full h-auto' %}
      {% else %}
        {% assign image_class = 'object-cover w-full h-auto aspect-[4/5]' %}
      {% endif %}
      {% assign image_class = image_class | append: ' ' | append: card_image_position %}
      <img
        src="{{ initial_img | image_url: width: 1800}}"
        :src="currentImage"
        alt="{{ product.title | escape }}"
        class="{{image_class }} duration-500 hover:opacity-85 transition-all hover:scale-110 "
        loading="lazy"
        width="1100"
        height="1100"
      >
      <template x-if="discount !== '0%' && discount !== '0'">
        <div class="absolute right-0 top-0 py-2 px-2 ">
          <span class="px-2 py-1 bg-red-500 rounded-full shadow-xl transition-opacity duration-200 text-white text-sm"
            >Sale</span
          >
        </div>
      </template>

      {% if quick_view %}
        <div class="absolute bottom-2 md:bottom-5 left-1/2 -translate-x-1/2 translate-y-16 lg:translate-y-30 group-hover/image:translate-y-0 transition-all duration-300 bg-white px-3 py-1.5 md:px-5 md:py-2 rounded-full shadow-xl text-black text-[10px] md:text-sm font-medium whitespace-nowrap">
          Quick View
        </div>
      {% endif %}
    </a>
  </div>
  {% comment %} Info {% endcomment %}
  {% assign split_title = product.title | split: ' ' %}
  {% assign has_multiple_variants = false %}
  {% if product.variants.size > 1 %}
    {% assign has_multiple_variants = true %}
  {% endif %}
  <div class="relative min-h-[3.5rem]">
    <div
      {% if has_multiple_variants %}
        :class="{ 'lg:group-hover/card:opacity-0': true }"
      {% endif %}
      class="font-sans pt-2 transition-opacity duration-200"
    >
      <a :href="currentUrl" class="flex flex-col gap-0.5">
        {% comment %} Vendor {% endcomment %}
        <div class="text-[9px] md:text-[10px] text-orange-500 font-medium uppercase tracking-widest">
          {{ product.vendor | capitalize }}
        </div>
        {% comment %} Title {% endcomment %}
        <h3 class="text-sm md:text-base p-0 m-0 tracking-tight font-medium text-gray-900 leading-tight">
          {% for word in split_title %}
            {{ word | capitalize }}
          {% endfor %}
        </h3>
        {% comment %} Type {% endcomment %}
        <div class="text-xs md:text-sm text-gray-400 font-normal mt-0.5">
          {{ product.type | capitalize }}
        </div>
        {% assign color_count = product.variants | map: 'option1' | uniq | size %}
        {% if color_count > 1 %}
          <div class="text-xs md:text-sm text-gray-400 font-normal">{{ color_count }} Colors</div>
        {% endif %}
      </a>
    </div>

    {% if has_multiple_variants %}
      {% comment %} Group variants by first option (typically color) {% endcomment %}
      {% assign unique_options = product.variants | map: 'option1' | uniq %}
      <div class="hidden lg:block absolute inset-0 opacity-0 group-hover/card:opacity-100 transition-opacity duration-200">
        <div
          class="flex gap-2 items-center text-center overflow-x-auto py-2 px-2"
        >
          {% for option_value in unique_options limit: 4 %}
            {% comment %} Find the first variant matching this option value {% endcomment %}
            {% assign matching_variant = null %}
            {% for variant in product.variants %}
              {% if variant.option1 == option_value %}
                {% assign matching_variant = variant %}
                {% break %}
              {% endif %}
            {% endfor %}

            {% if matching_variant %}
              {%- assign variant_image = matching_variant.featured_image
                | default: product.featured_image
                | image_url: width: 1100
              -%}
              {%- liquid
                if matching_variant.compare_at_price and matching_variant.compare_at_price > 0
                  assign variant_discount = matching_variant.compare_at_price | minus: matching_variant.price | times: 100 | divided_by: matching_variant.compare_at_price | round
                else
                  assign variant_discount = 0
                endif
              -%}

              <a
                href="{{matching_variant.url | within: collection}}"
                @mouseenter="
                  currentImage = '{{ variant_image }}';
                  currentPrice = '{{ matching_variant.price | money }}';
                  currentCompareAtPrice = '{{ matching_variant.compare_at_price | money }}';
                  discount = '{{ variant_discount }}%';
                  currentUrl = '{{ matching_variant.url | within: collection }}';
                  activeVariantId = {{ matching_variant.id }};
                "
                :class="{ 'ring-2 ring-indigo-500': activeVariantId === {{ matching_variant.id }} }"
                class="size-8 shrink-0 rounded-md border border-gray-300 hover:opacity-60 bg-cover bg-center transition-all"
                style="background-image: url('{{ matching_variant.featured_image | default: product.featured_image | image_url: width: 50 }}');"
                aria-label="{{ matching_variant.title }}"
              ></a>
            {% endif %}
          {% endfor %}
          {%- assign total_unique_options = unique_options | size -%}
          {% if total_unique_options > 4 %}
            <p class="text-gray-300 text-lg ">+{{ total_unique_options | minus: 4 }}</p>
          {% endif %}
        </div>
      </div>
    {% endif %}
  </div>

  {% comment %} Price {% endcomment %}
  <a :href="currentUrl">
    <p
      class=" flex gap-2 tracking-tight items-center"
    >
      <span class="text-md font-medium text-black" x-text="currentPrice">
        {{- first_variant.price | money -}}
      </span>
      <span class="text-sm text-end text-gray-400 line-through " x-text="currentCompareAtPrice">
        {{- first_variant.compare_at_price | money -}}
      </span>

      <template x-if="discount !== '0%' && discount !== '0'">
        <span
          class="text-md text-end text-green-600 font-medium"
          x-text="discount + '  off'"
        >
        </span>
      </template>
    </p>
  </a>
</div>
